name: Word Collector â€“ Add words to dictionary.json

on:
  issues:
    types: [labeled]

jobs:
  add-words:
    if: github.event.label.name == 'approved'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        - name: Install jq
  run: sudo apt-get update && sudo apt-get install -y jq

      - name: Parse issue body
        id: parse
        run: |
          BODY="${{ github.event.issue.body }}"
          # Extract fields (case-insensitive)
          TAUSUG=$(echo "$BODY" | grep -i '^Tausug:' | sed 's/^Tausug: //i' | head -1 | xargs)
          ENGLISH=$(echo "$BODY" | grep -i '^English:' | sed 's/^English: //i' | head -1 | xargs)
          CATEGORY=$(echo "$BODY" | grep -i '^Category:' | sed 's/^Category: //i' | head -1 | tr '[:upper:]' '[:lower:]' | xargs)
          PRONUN=$(echo "$BODY" | grep -i '^Pronunciation:' | sed 's/^Pronunciation: //i' | head -1 | xargs)
          
          echo "tausug=$TAUSUG" >> $GITHUB_OUTPUT
          echo "english=$ENGLISH" >> $GITHUB_OUTPUT
          echo "category=$CATEGORY" >> $GITHUB_OUTPUT
          echo "pronunciation=$PRONUN" >> $GITHUB_OUTPUT

      - name: Debug parsed values
        run: |
          echo "Tausug: ${{ steps.parse.outputs.tausug }}"
          echo "English: ${{ steps.parse.outputs.english }}"
          echo "Category: ${{ steps.parse.outputs.category }}"
          echo "Pronunciation: ${{ steps.parse.outputs.pronunciation }}"

      - name: Update dictionary.json
        run: |
          TAUSUG="${{ steps.parse.outputs.tausug }}"
          ENGLISH="${{ steps.parse.outputs.english }}"
          CATEGORY="${{ steps.parse.outputs.category }}"
          PRONUN="${{ steps.parse.outputs.pronunciation }}"
          FILE="json/dictionary.json"
          TODAY=$(date +%Y-%m-%d)

          # If dictionary.json doesn't exist, create a minimal one
          if [ ! -f "$FILE" ]; then
            echo '{"metadata":{"version":"2.0","lastUpdated":"'$TODAY'","totalWords":0,"contributors":[],"categories":[]},"words":[]}' > "$FILE"
          fi

          # Build jq filter
          # Add the new word to the words array, update metadata
          jq --arg t "$TAUSUG" \
             --arg e "$ENGLISH" \
             --arg c "$CATEGORY" \
             --arg p "$PRONUN" \
             --arg today "$TODAY" \
            '.words += [{
               tausug: $t,
               english: $e,
               category: $c,
               pronunciation: (if $p == "" then null else $p end)
             }] |
             .metadata.totalWords = (.words | length) |
             .metadata.lastUpdated = $today |
             .metadata.categories = (.metadata.categories + [$c] | unique | sort)
            ' "$FILE" > tmp.json && mv tmp.json "$FILE"

      - name: Show updated file
        run: cat json/dictionary.json

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Add ${{ steps.parse.outputs.tausug }} (from issue #${{ github.event.issue.number }})"
          title: "Add new word: ${{ steps.parse.outputs.tausug }} = ${{ steps.parse.outputs.english }}"
          body: |
            This PR adds the word submitted in issue #${{ github.event.issue.number }}.

            **Tausug:** ${{ steps.parse.outputs.tausug }}
            **English:** ${{ steps.parse.outputs.english }}
            **Category:** ${{ steps.parse.outputs.category }}
            **Pronunciation:** ${{ steps.parse.outputs.pronunciation || '(none)' }}
          branch: add-word-${{ github.event.issue.number }}
          base: main
          labels: word-submission, automated-pr

      - name: Enable auto-merge on PR
        if: steps.create-pr.outputs.pull-request-number != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ steps.create-pr.outputs.pull-request-number }}"
          gh pr merge $PR_NUMBER --auto --merge
