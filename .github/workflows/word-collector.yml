name: Word Collector – Add words to dictionary.json

on:
  issues:
    types: [labeled]

jobs:
  add-words:
    if: github.event.label.name == 'approved'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Parse issue body
        id: parse
        run: |
          BODY="${{ github.event.issue.body }}"
          TAUSUG=$(echo "$BODY" | grep -i '^Tausug:' | sed 's/^Tausug: //i' | head -1)
          ENGLISH=$(echo "$BODY" | grep -i '^English:' | sed 's/^English: //i' | head -1)
          CATEGORY=$(echo "$BODY" | grep -i '^Category:' | sed 's/^Category: //i' | head -1 | tr '[:upper:]' '[:lower:]')
          echo "tausug=$TAUSUG" >> $GITHUB_OUTPUT
          echo "english=$ENGLISH" >> $GITHUB_OUTPUT
          echo "category=$CATEGORY" >> $GITHUB_OUTPUT

      - name: Debug parsed values
        run: |
          echo "Tausug: ${{ steps.parse.outputs.tausug }}"
          echo "English: ${{ steps.parse.outputs.english }}"
          echo "Category: ${{ steps.parse.outputs.category }}"

      - name: Check file existence
        run: |
          echo "Current directory: $(pwd)"
          ls -la json/ || echo "json/ folder not found"
          if [ -f "json/dictionary.json" ]; then
            echo "✅ dictionary.json exists"
          else
            echo "❌ dictionary.json not found"
          fi

      - name: Update dictionary.json
        run: |
          TAUSUG="${{ steps.parse.outputs.tausug }}"
          ENGLISH="${{ steps.parse.outputs.english }}"
          CATEGORY="${{ steps.parse.outputs.category }}"
          FILE="json/dictionary.json"

          if [ ! -f "$FILE" ]; then
            echo '{"metadata":{"version":"1.0"},"noun":{},"pronoun":{},"verb":{},"adjective":{},"adverb":{},"preposition":{},"conjunction":{},"article":{},"interjection":{},"phrase":{},"sentence":{}}' > "$FILE"
          fi

          jq --arg cat "$CATEGORY" --arg key "$TAUSUG" --arg val "$ENGLISH" \
            '.[$cat] += {($key): $val}' "$FILE" > tmp.json && mv tmp.json "$FILE"

      - name: Show updated file
        run: |
          echo "Updated dictionary.json:"
          cat json/dictionary.json

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Add ${{ steps.parse.outputs.tausug }} (from issue #${{ github.event.issue.number }})"
          title: "Add new word: ${{ steps.parse.outputs.tausug }} = ${{ steps.parse.outputs.english }}"
          body: |
            This PR adds the word submitted in issue #${{ github.event.issue.number }}.

            **Tausug:** ${{ steps.parse.outputs.tausug }}
            **English:** ${{ steps.parse.outputs.english }}
            **Category:** ${{ steps.parse.outputs.category }}
          branch: add-word-${{ github.event.issue.number }}
          base: main
          labels: word-submission, automated-pr

      - name: Enable auto-merge on PR
        if: steps.create-pr.outputs.pull-request-number != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ steps.create-pr.outputs.pull-request-number }}"
          gh pr merge $PR_NUMBER --auto --merge
